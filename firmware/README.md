# ESP32 Firmware Project

This firmware is developed for the **ESP32-C3-DevKitM-1** module using **ESP-IDF** framework. The project demonstrates connecting the ESP32 device to a Wi-Fi network, communicating securely with an MQTT broker, and controlling an WS2812 LED strip based on MQTT messages. The firmware is built and compiled inside **WSL Ubuntu** environment, while development is done in **Visual Studio Code** with the ESP-IDF extension.

---

## Features

- Connects to Wi-Fi using predefined SSID and password
- Connects securely to a HiveMQ MQTT broker via TLS
- Subscribes to topic `"home/temperature"` and changes WS2812 LED color based on message:
  - `"increase"` → Green LED
  - `"decrease"` → Red LED
  - Other messages → Blue LED
- Publishes random temperature, humidity, and light data every 5 seconds on MQTT topics:
  - `"esp/in/temperature"`
  - `"esp/in/humidity"`
  - `"esp/in/light"`
- Uses ESP-IDF's native MQTT client and Wi-Fi libraries
- WS2812 LED strip control using `led_strip` component
- Developed and compiled under WSL Ubuntu, with VSCode ESP-IDF extension support

---

## Hardware Used

- **ESP32-C3-DevKitM-1** (RISC-V core, Wi-Fi & BLE enabled microcontroller)
- WS2812 RGB LED strip connected to GPIO 8 (configurable)
- Optional: Relay pin (commented out in code)

---

## Software & Tools

- [ESP-IDF](https://docs.espressif.com/projects/esp-idf/en/latest/esp32c3/get-started/)
- Visual Studio Code with [ESP-IDF extension](https://marketplace.visualstudio.com/items?itemName=espressif.esp-idf-extension)
- WSL Ubuntu for building and flashing firmware
- Docker (for devcontainer environment)
- HiveMQ Cloud MQTT Broker (or any MQTT broker with TLS support)

---

## Setup and Build Instructions

### 1. Clone or copy the repository to your WSL Ubuntu home or workspace

```bash
cd ~
git clone <your-repo-url> firmware
cd firmware/esp32_wsl_example

# 2. Configure Wi-Fi credentials

Edit the `wifi_config.h` file:

```c
#define WIFI_SSID "YourWiFiSSID"
#define WIFI_PASS "YourWiFiPassword"

# 3. Configure MQTT broker credentials

In `main.c`, update the following macros with your MQTT broker information:

```c
#define MQTT_BROKER_URI "mqtts://yourbroker:port"
#define MQTT_USERNAME   "your_username"
#define MQTT_PASSWORD   "your_password"

# 4. Build the firmware

Inside WSL terminal (Ubuntu):

```bash
idf.py build

# 5. Flash the firmware to ESP32

Connect your ESP32 device via USB and run:

```bash
idf.py -p /dev/ttyUSB0 flash monitor

# How the Firmware Works

- **Wi-Fi connection:** The device connects to the configured Wi-Fi network and automatically reconnects if disconnected.

- **MQTT connection:** After obtaining an IP, it connects securely to the MQTT broker using TLS certificate stored as binary data.

- **LED control:** Subscribes to the `"home/temperature"` topic. Based on received messages, the LED color changes.

- **Data publishing:** Every 5 seconds, publishes random simulated sensor data (temperature, humidity, light) to respective MQTT topics.

# Configuration Details

- **GPIO for WS2812 LED:** GPIO 8 by default, configurable in `main.c`

- **Number of LEDs:** 1 (single LED) by default, change `LED_NUM` in `main.c` if needed

- **TLS certificate:** Embedded as binary data, see `CMakeLists.txt` and certificate file `hivemq_cert.pem`

- **Build configuration:** `sdkconfig` generated by `idf.py menuconfig`, you can run this to customize

# Useful Commands

**Configure build options:**

```bash
idf.py menuconfig

**Clean build files:**

```bash
idf.py fullclean

**Build project:**

```bash
idf.py build

**Flash and monitor serial output:**

```bash
idf.py -p <PORT> flash monitor

Exit serial monitor: Ctrl + ]

# Troubleshooting

- **Wi-Fi connection issues:**  
  Double-check SSID and password in `wifi_config.h`.

- **MQTT connection errors:**  
  Verify MQTT broker URI, username, password, and certificate. Ensure network access.

- **LED strip not lighting:**  
  Check wiring to GPIO 8, LED strip type and power supply.

- **Build errors:**  
  Ensure you use the ESP-IDF version >= 4.1.0 and that your environment variables are correctly set.

- **Permission issues on USB port:**  
  Add your user to the `dialout` group or run with `sudo`.

# Additional Notes

- This project uses a Docker-based devcontainer setup for consistent development environment with ESP-IDF and QEMU emulator.

- The example code uses simulated sensor values (random numbers) for demonstration purposes. Replace with real sensor drivers as needed.

- The code is modular: LED driver is implemented as a separate component under `components/led_strip`.

# Code Explanation

### Wi-Fi Connection:
The `wifi_init()` function initializes the Wi-Fi driver and connects the ESP32 device to the configured Wi-Fi network using the credentials defined in `wifi_config.h`. It handles connection retries and status monitoring to ensure a stable connection.

### MQTT Connection:
Once Wi-Fi is successfully connected, the firmware establishes a secure MQTT connection to the broker using TLS. The MQTT client authenticates with the broker using the username and password constants (`MQTT_USERNAME`, `MQTT_PASSWORD`) defined in `main.c`.

### MQTT Messaging:
- The device subscribes to the topic `"home/temperature"` to listen for incoming commands. Based on the message payload, it changes the LED strip color as follows:
  - `"increase"` → Set LED color to Green
  - `"decrease"` → Set LED color to Red
  - Any other message → Set LED color to Blue

- The device periodically publishes simulated sensor data (random values) to the following topics:
  - `"esp/in/temperature"`
  - `"esp/in/humidity"`
  - `"esp/in/light"`

This simulates real-time data reporting for temperature, humidity, and light intensity.

### LED Strip Control:
The WS2812 LED strip is controlled through the `led_strip` component. The firmware uses this driver to set the color and brightness of the LEDs based on MQTT commands or internal logic.

# Customization

### Wi-Fi Configuration:
You can modify the Wi-Fi SSID and password in the `wifi_config.h` file to match your local network credentials.

### MQTT Broker Settings:
The MQTT broker URI (`MQTT_BROKER_URI`), username (`MQTT_USERNAME`), and password (`MQTT_PASSWORD`) are defined as constants inside the `main.c` file. Update these values to connect to your own MQTT broker.

### LED Pin and Number of LEDs:
The GPIO pin used to control the LED strip is set via the `LED_GPIO` macro, and the number of LEDs in the strip is defined by `LED_NUM`. Adjust these macros according to your hardware setup.

### Extending MQTT Command Handling:
You can add new commands and corresponding actions inside the MQTT message callback handler to expand the device’s functionality. This allows you to customize how the device reacts to different MQTT messages, enabling features like different light patterns, device modes, or triggering other hardware peripherals.

